#set($zoom = $request.params.get('zoom'))
#if( ! $zoom )
    #set( $zoom = "11" )
#end

<input type="hidden" id="zoom" name="zoom" value="$zoom"/>

#set($mapbounds = $request.params.get('mapbounds'))
#if( ! $mapbounds )
    #set( $mapbounds = "((52.336629759881994, 13.12110710144043), (52.5977202559773, 13.720305633544967))" )
#end
 
#set($queryOpts = $params.get("queryOpts"))

<script src="http://code.jquery.com/jquery-1.8.3.min.js"></script>
## <script src="http://code.jquerygeo.com/jquery.geo-1.0.0-b1.5.min.js"></script>
## <script>
## $(function() { $( "#map" ).geomap({ 
## center: [13.3888599,52.5170365],
## zoom: 12
## } ); });
## </script>
 
<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false&libraries=drawing"></script>

<script> 
function initialize() {
    var zoomc = document.getElementById("zoom").value ;
    var mapbounds = document.getElementById("mapbounds").value ;
    var mapOptions = {
    center:  new google.maps.LatLng(52.5170365, 13.3888599), 
    zoom: 11
  };
  var map = new google.maps.Map(document.getElementById('map-canvas'),
      mapOptions);

    var x = zoomc/1  
    map.setOptions({zoom:x})
    document.getElementById('zoom').value = x 
      
   var north = document.getElementById("north").value;
    var	south = document.getElementById("south").value;
	var east = document.getElementById("east").value;
	var west = document.getElementById("west").value ; 
    
    var newcenter = new google.maps.LatLng((north/1+south/1)/2,(east/1+west/1)/2) 
    map.setOptions({center:newcenter})
   
    var els =  document.getElementsByName("markerinfo")  
    var markers = []
    var titles = []
    var infowindows = []
    for (var i=0; i<els.length;i++){   
	var el = els[i] 
	var l = el.childNodes[1].value
	var title = el.childNodes[3].value
	var link = el.childNodes[5].value
	var pos = new google.maps.LatLng(l.split(',')[0],l.split(',')[1]) 
	marker = new google.maps.Marker({
	    position: pos,
	    map: map,
	    title: title,
	});   
	var infowindow = new google.maps.InfoWindow({
	    content: title  
	});
	markers.push(marker) 
	infowindows.push(infowindow)
    } 
##     for (var i=0; i<markers.length;i++){  
## 	alert(titles[i])
## 	iw = infowindows[i]
## 	alert(iw.content)
## 	google.maps.event.addListener(markers[i], 'click', function() {
## 		iw.open(map,markers[i]);
## 	});
##     }

  var bounds = new google.maps.LatLngBounds(
      new google.maps.LatLng(south, west),
      new google.maps.LatLng(north, east)
  );

  // Define a rectangle and set its editable property to true.
  var rectangle = new google.maps.Rectangle({
    bounds: bounds,
    editable: true,
    strokeColor: 'black',
    strokeOpacity: 0.8,
    strokeWeight: 2,
    fillColor: 'orange',
  });
 

  google.maps.event.addListener(rectangle, 'click', function() { 
    var ne =rectangle.bounds.getNorthEast()
    var sw = rectangle.bounds.getSouthWest()
    var n = ne.toString().split(',')[0].replace('(','')
    var e = ne.toString().split(',')[1].replace(')','')
    var s = sw.toString().split(',')[0].replace('(','')
    var w = sw.toString().split(',')[1].replace(')','') 
    document.getElementById("north").value = n
    document.getElementById("east").value = e
    document.getElementById("south").value = s
    document.getElementById("west").value = w 
    document.getElementById("zoom").value = map.getZoom() 
    document.getElementById("mapbounds").value = rectangle.getBounds()

    $('#query-form').submit()
  });

  rectangle.setMap(map);
}
 
google.maps.event.addDomListener(window, 'load', initialize); 
</script>


#if($queryOpts == "spatial")


<div>
    #set($loc = $request.params.get('pt'))
    ## Normalize first trip through to "none" because
    ## an empty string generates an error message later on
    #if( ! $loc )
	#set( $loc = "none" )
    #end 
    #set($north = $request.params.get('north'))
    #if( ! $north )
	#set( $north = "52.48971133018803" )
    #end
    #set($west = $request.params.get('west'))
    #if( ! $west )
	#set( $west = "13.381274414062545" )
    #end
    #set($south = $request.params.get('south'))
    #if( ! $south )
	#set( $south = "52.46405332492973" )
    #end
    #set($east = $request.params.get('east'))
    #if( ! $east )
	#set( $east = "13.43121337890625" )
    #end 
    <div style="width:100%;">  
	<table style="text-align:center; width:100%">
	<tr style="text-align:center;  ">
	<td style="text-align:center;  "> zum Aktualisieren auf das Rechteck klicken!</td>
	</tr>
	<tr><td> <div id="map-canvas" style="height: 320px; "></div> </td></tr>
	</table> 
    </div>

    <input type="hidden" name="sfield" value="location"/>
    <input type="hidden" id="spatialFQ" name="fq" value=""/>
    <input type="hidden" name="queryOpts" value="spatial"/>   
    <input type="hidden" id="fq" name="fq" />  
    <input type="hidden" id="mapbounds" name="mapbounds" value="$mapbounds"/>
    <input type="hidden" id="north" name="north" value="$north"/>
    <input type="hidden" id="east" name="east"value="$east"/>
    <input type="hidden" id="south" name="south"   value="$south"/>
    <input type="hidden" id="west" name="west" value="$west"/>  
    <input type="hidden" id="rows" name="rows" value="100"/>    
</div> 

<script type="text/javascript">
    $('#query-form').submit(function() {
##       if ($("#pt").val() != "none") {
##         $("#spatialFQ").val("{!bbox}");
##       }	
	$eastc = $("#east").val().trim()
	$westc = $("#west").val().trim()
	$southc = $("#south").val().trim()
	$northc = $("#north").val().trim()
	$rechteckstring = "location:["+$southc+","+$westc+" TO "+$northc+","+$eastc+"]" 
	
      $fqs = $("#allFQs").val(); 
##       $fqs = $fqs.replace("{!bbox}", "");
      if ($fqs == ''){
        $("#allFQs").remove();
      }


      $("#allFQs").val($fqs);
	$("#fq").val($rechteckstring);
      return true;
    });
</script>

#end
